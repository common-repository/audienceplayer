export default class EmbedPlayer{constructor(){this.isPlaying=!1,this.isFirstPlay=!0,this.lastPlayTime=Date.now(),this.myPlayer=null,this.castPlayer=null,this.castContext=null,this.castPlayerController=null}initPlayer(e){this.destroy();const t=document.querySelector(e),a=document.createElement("video");a.setAttribute("class",["azuremediaplayer","amp-flush-skin","amp-big-play-centered"].join(" ")),a.setAttribute("tabIndex","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("id","azuremediaplayer"),t.appendChild(a)}play({selector:e,apiBaseUrl:t,projectId:a,articleId:r,assetId:s,token:i,posterImageUrl:n,autoplay:o,fullScreen:l}){if(!e)return Promise.reject("selector property is missing");if(!t)return Promise.reject("apiBaseUrl property is missing");if(!r)return Promise.reject("articleId property is missing");if(!s)return Promise.reject("assetId property is missing");if(!a)return Promise.reject("projectId property is missing");const c=`${t}/graphql/${a}`,p=`${t}/service/analytics/stream/pulse/`;return this.initPlayer(e),this.getPlayConfig(c,r,s,p,i).then(e=>(this.playVideo(e,n,!!o,l),e))}destroy(){this.myPlayer&&(this.myPlayer.dispose(),this.myPlayer=null)}playVideo(e,t,a,r){const s=document.querySelector("video");var i={autoplay:a,controls:!0,fluid:!0};t&&(i.poster=t),this.myPlayer=amp(s,i),this.myPlayer.src(e.config.player,e.config.options),this.bindEvents(e),r&&this.myPlayer.enterFullscreen()}bindEvents(e){this.myPlayer&&(this.myPlayer.addEventListener("error",t=>this.eventHandler(t,e)),this.myPlayer.addEventListener("ended",t=>this.eventHandler(t,e)),this.myPlayer.addEventListener("pause",t=>this.eventHandler(t,e)),this.myPlayer.addEventListener("timeupdate",t=>this.eventHandler(t,e)),this.myPlayer.addEventListener("playing",t=>this.eventHandler(t,e)))}eventHandler(e,t){switch(e.type){case"timeupdate":this.isPlaying&&Date.now()-this.lastPlayTime>3e4&&(this.sendPulse(t.heartBeatUrl+"update",this.getHeartBeatParams(t)),this.lastPlayTime=Date.now());break;case"playing":this.isFirstPlay&&(this.isFirstPlay=!1,this.myPlayer.currentTime(t.currentTime)),this.sendPulse(t.heartBeatUrl+"init",this.getHeartBeatParams(t)),this.lastPlayTime=Date.now(),this.isPlaying=!0;break;case"pause":this.sendPulse(t.heartBeatUrl+"update",this.getHeartBeatParams(t)),this.lastPlayTime=Date.now(),this.isPlaying=!1;break;case"ended":this.sendPulse(t.heartBeatUrl+"finish",this.getHeartBeatParams(t)),this.lastPlayTime=Date.now(),this.isPlaying=!1}}getHeartBeatParams(e){return{appa:""+this.myPlayer.currentTime(),appr:""+Math.min(this.myPlayer.currentTime()/this.myPlayer.duration(),1),pulseToken:e.pulseToken}}sendPulse(e,t){const a=`${e}?pulse_token=${t.pulseToken}&appa=${t.appa}&appr=${t.appr}`;fetch(a).then()}getPlayConfig(e,t,a,r,s){let i={},n={};return this.getArticle(e,t,s).then(e=>e.json()).then(r=>{if(!r||!r.data||r.errors){const{message:e,code:t}=r.errors[0];throw{message:e,code:t}}return i={...r.data.Article},this.getArticleAssetPlayConfig(e,t,a,s)}).then(e=>e.json()).then(e=>{if(!e||!e.data||e.errors){const{message:t,code:a}=e.errors[0];throw{message:t,code:a}}return n=this.toPlayConfigConverter(i,a,e.data.ArticleAssetPlay,r)})}getArticle(e,t,a){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...a?{Authorization:"Bearer "+a}:{}},body:JSON.stringify({query:"\n            query Article($articleId: Int!) {\n                Article(id: $articleId) {\n                    id\n                    name\n                    assets {\n                        id\n                        duration\n                        linked_type\n                        accessibility\n                    }\n                    posters {\n                        type\n                        url\n                        title\n                        base_url\n                        file_name\n                    }\n                }\n            }\n        ",variables:{articleId:t}})})}getArticleAssetPlayConfig(e,t,a,r){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...r?{Authorization:"Bearer "+r}:{}},body:JSON.stringify({query:"\n            mutation ArticleAssetPlay($articleId: Int, $assetId: Int, $protocols: [ArticlePlayProtocolEnum]) {\n                ArticleAssetPlay(article_id: $articleId, asset_id: $assetId, protocols: $protocols) {\n                    article_id\n                    asset_id\n                    entitlements {\n                        mime_type\n                        protocol\n                        manifest\n                        token\n                        encryption_type\n                    }\n                    subtitles_new {\n                        url\n                        locale\n                        locale_label\n                    }\n                    pulse_token\n                    appa\n                    appr\n                    fairplay_certificate_url\n                }\n            }\n        ",variables:{articleId:t,assetId:a,protocols:["dash","mss","hls"]}})})}toPlayConfigConverter(e,t,a,r){const s=e.assets.find(e=>e.id===t),i=a.subtitles_new.map(e=>({src:e.url,srclang:e.locale,kind:"subtitles",label:e.locale_label}));return{config:{player:this.getPlayerConfig(a),options:this.isSafari()?[]:[...i]},pulseToken:a.pulse_token,appa:a.appa,appr:a.appr,article:e,assetType:s.linked_type,asset:s,currentTime:a.appa/s.duration<=.98?a.appa:0,heartBeatUrl:r}}isSafari(){let e=navigator.userAgent.indexOf("Chrome")>-1,t=navigator.userAgent.indexOf("Chrome")>-1;return e&&t&&(t=!1),t}getPlayerConfig(e){const t=[];return(!!e.entitlements.find(e=>"fps"===e.encryption_type)?e.entitlements.filter(e=>"aes"!==e.encryption_type):e.entitlements).forEach(a=>{const r={src:a.manifest,type:a.mime_type,protectionInfo:null};a.token&&("cenc"===a.encryption_type?r.protectionInfo=[{type:"PlayReady",authenticationToken:"Bearer="+a.token},{type:"Widevine",authenticationToken:"Bearer "+a.token}]:"fps"===a.encryption_type&&(r.protectionInfo=[{type:"FairPlay",authenticationToken:"Bearer "+a.token,certificateUrl:e.fairplay_certificate_url}])),t.push(r)}),t}setupChromecast(e,t){const a=document.querySelector(e),r=document.createElement("google-cast-launcher");if(a.appendChild(r),t){window.__onGCastApiAvailable=e=>{e&&cast&&cast.framework&&this.initializeCastApi(t)};const e=document.createElement("script");e.src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",document.head.appendChild(e)}}initializeCastApi(e){cast.framework.CastContext.getInstance().setOptions({receiverApplicationId:e,autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),this.castContext=cast.framework.CastContext.getInstance(),this.castPlayer=new cast.framework.RemotePlayer,this.castPlayerController=new cast.framework.RemotePlayerController(this.castPlayer)}getCastMediaInfo(e){if(e&&e.config&&e.config.player){const t=e.config.options.map((e,t)=>{const a=t+1,r=new chrome.cast.media.Track(a,chrome.cast.media.TrackType.TEXT);return r.trackContentId=e.src,r.trackContentType="text/vtt",r.subtype=chrome.cast.media.TextTrackType.SUBTITLES,r.name=e.label,r.language=e.srclang,r.customDate=null,r}),a="application/vnd.ms-sstr+xml",r=e.config.player.find(e=>e.type===a),s=r.protectionInfo.find(e=>"PlayReady"===e.type),i=s?s.authenticationToken:null,n=new chrome.cast.media.MediaInfo(r.src,a);return n.streamType=chrome.cast.media.StreamType.BUFFERED,n.metadata=new chrome.cast.media.GenericMediaMetadata,n.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC,n.metadata.title=e.article.name,n.tracks=t,n.customData={...this.getLicenseUrlFromSrc(r.src,i),pulseToken:e.pulseToken},n.currentTime=e.currentTime,n.autoplay=!0,n}return null}getLicenseUrlFromSrc(e,t){if(t){const a=e.match(/^https:\/\/([^.]+)\.streaming\.mediaservices\.windows\.net\/.*/i),r=e.match(/^https:\/\/([a-z0-9_]+)-euwe.streaming\.media\.azure\.net\/.*/i),s=a||r;if(s&&2===s.length){return{licenseUrl:"https://"+s[1]+".keydelivery.westeurope.media.azure.net/PlayReady/?token="+encodeURIComponent(t),token:t}}}return{}}castVideo({apiBaseUrl:e,projectId:t,articleId:a,assetId:r,token:s}){if(!e)return Promise.reject("apiBaseUrl property is missing");if(!a)return Promise.reject("articleId property is missing");if(!r)return Promise.reject("assetId property is missing");if(!t)return Promise.reject("projectId property is missing");const i=`${e}/graphql/${t}`;return this.getPlayConfig(i,a,r,null,s).then(e=>{if(this.isConnected()){const t=this.castContext.getCurrentSession(),a=this.getCastMediaInfo(e);if(a){const r=new chrome.cast.media.LoadRequest(a);return r.currentTime=e.currentTime,t.loadMedia(r)}throw{message:"Unexpected manifest format in articlePlayConfig"}}return e})}isConnected(){return this.castPlayer&&this.castPlayer.isConnected}stopCasting(){cast.framework.CastContext.getInstance().getCurrentSession().endSession(!0)}getCastPlayer(){return this.castPlayer}getCastPlayerController(){return this.castPlayerController}}
