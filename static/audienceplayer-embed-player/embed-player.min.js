export default class EmbedPlayer{constructor(){this.isPlaying=!1,this.isFirstPlay=!0,this.lastPlayTime=Date.now(),this.myPlayer=null,this.castPlayer=null,this.castContext=null,this.castPlayerController=null,this.configData=null}initPlayer(e){this.destroy();const t=document.querySelector(e),a=document.createElement("video");a.setAttribute("class",["azuremediaplayer","amp-flush-skin","amp-big-play-centered"].join(" ")),a.setAttribute("tabIndex","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("id","azuremediaplayer"),t.appendChild(a)}play({selector:e,apiBaseUrl:t,projectId:a,articleId:r,assetId:i,token:n,posterImageUrl:s,autoplay:o,fullScreen:l}){if(!e)return Promise.reject("selector property is missing");if(!t)return Promise.reject("apiBaseUrl property is missing");if(!r)return Promise.reject("articleId property is missing");if(!i)return Promise.reject("assetId property is missing");if(!a)return Promise.reject("projectId property is missing");const c=`${t}/graphql/${a}`,p=`${t}/service/${a}/analytics/stream/pulse/`;return this.initPlayer(e),this.getPlayConfig(c,r,i,p,n).then(e=>(this.playVideo(e,s,!!o,l),e))}destroy(){this.myPlayer&&(this.configData&&this.eventHandler({type:"ended"}),this.myPlayer.dispose(),this.myPlayer=null),this.isFirstPlay=!0,this.isPlaying=!1,this.configData=null}playVideo(e,t,a,r){this.configData=e,this.lastPlayTime=Date.now();const i=document.querySelector("video");var n={autoplay:a,controls:!0,fluid:!0};t&&(n.poster=t),this.myPlayer=amp(i,n),this.myPlayer.src(this.configData.config.player,this.configData.config.options),this.bindEvents(),r&&this.myPlayer.enterFullscreen()}bindEvents(){this.myPlayer&&(this.myPlayer.addEventListener("error",e=>this.eventHandler(e)),this.myPlayer.addEventListener("ended",e=>this.eventHandler(e)),this.myPlayer.addEventListener("pause",e=>this.eventHandler(e)),this.myPlayer.addEventListener("timeupdate",e=>this.eventHandler(e)),this.myPlayer.addEventListener("playing",e=>this.eventHandler(e)))}eventHandler(e){switch(e.type){case"timeupdate":this.isPlaying&&Date.now()-this.lastPlayTime>3e4&&(this.sendPulse(this.configData.heartBeatUrl+"update",this.getHeartBeatParams()),this.lastPlayTime=Date.now());break;case"playing":this.isFirstPlay&&(this.isFirstPlay=!1,this.myPlayer.currentTime(this.configData.currentTime)),this.sendPulse(this.configData.heartBeatUrl+"init",this.getHeartBeatParams()),this.lastPlayTime=Date.now(),this.isPlaying=!0;break;case"pause":this.sendPulse(this.configData.heartBeatUrl+"update",this.getHeartBeatParams()),this.lastPlayTime=Date.now(),this.isPlaying=!1;break;case"ended":this.sendPulse(this.configData.heartBeatUrl+"finish",this.getHeartBeatParams()),this.lastPlayTime=Date.now(),this.isPlaying=!1}}getHeartBeatParams(){return{appa:""+this.myPlayer.currentTime(),appr:""+Math.min(this.myPlayer.currentTime()/this.myPlayer.duration(),1),pulseToken:this.configData.pulseToken}}sendPulse(e,t){const a=`${e}?pulse_token=${t.pulseToken}&appa=${t.appa}&appr=${t.appr}`;fetch(a).then()}getPlayConfig(e,t,a,r,i){let n={},s={};return this.getArticle(e,t,i).then(e=>e.json()).then(r=>{if(!r||!r.data||r.errors){const{message:e,code:t}=r.errors[0];throw{message:e,code:t}}return n={...r.data.Article},this.getArticleAssetPlayConfig(e,t,a,i)}).then(e=>e.json()).then(e=>{if(!e||!e.data||e.errors){const{message:t,code:a}=e.errors[0];throw{message:t,code:a}}return s=this.toPlayConfigConverter(n,a,e.data.ArticleAssetPlay,r)})}getArticle(e,t,a){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...a?{Authorization:"Bearer "+a}:{}},body:JSON.stringify({query:"\n            query Article($articleId: Int!) {\n                Article(id: $articleId) {\n                    id\n                    name\n                    assets {\n                        id\n                        duration\n                        linked_type\n                        accessibility\n                    }\n                    posters {\n                        type\n                        url\n                        title\n                        base_url\n                        file_name\n                    }\n                }\n            }\n        ",variables:{articleId:t}})})}getArticleAssetPlayConfig(e,t,a,r){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...r?{Authorization:"Bearer "+r}:{}},body:JSON.stringify({query:"\n            mutation ArticleAssetPlay($articleId: Int, $assetId: Int, $protocols: [ArticlePlayProtocolEnum]) {\n                ArticleAssetPlay(article_id: $articleId, asset_id: $assetId, protocols: $protocols) {\n                    article_id\n                    asset_id\n                    entitlements {\n                        mime_type\n                        protocol\n                        manifest\n                        token\n                        encryption_type\n                        key_delivery_url\n                    }\n                    subtitles {\n                        url\n                        locale\n                        locale_label\n                    }\n                    pulse_token\n                    appa\n                    appr\n                    fairplay_certificate_url\n                }\n            }\n        ",variables:{articleId:t,assetId:a,protocols:["dash","mss","hls"]}})})}toPlayConfigConverter(e,t,a,r){const i=e.assets.find(e=>e.id===t),n=a.subtitles.map(e=>({src:e.url,srclang:e.locale,kind:"subtitles",label:e.locale_label}));return{config:{player:this.getPlayerConfig(a),options:this.isSafari()?[]:[...n]},pulseToken:a.pulse_token,appa:a.appa,appr:a.appr,article:e,assetType:i.linked_type,asset:i,currentTime:a.appa/i.duration<=.98?a.appa:0,heartBeatUrl:r}}isSafari(){let e=navigator.userAgent.indexOf("Chrome")>-1,t=navigator.userAgent.indexOf("Chrome")>-1;return e&&t&&(t=!1),t}getPlayerConfig(e){const t=[],a=!!e.entitlements.find(e=>"fps"===e.encryption_type)?e.entitlements.filter(e=>"aes"!==e.encryption_type):e.entitlements,r=a.find(e=>!!e.token&&"cenc"===e.encryption_type&&0===e.protocol.indexOf("dash")),i=a.find(e=>!!e.token&&"cenc"===e.encryption_type&&0===e.protocol.indexOf("mss"));return a.forEach(a=>{const n={src:a.manifest,type:a.mime_type,protectionInfo:null};a.token&&(n.protectionInfo=[],"cenc"===a.encryption_type?(r&&n.protectionInfo.push({type:"Widevine",authenticationToken:"Bearer "+r.token,keyDeliveryUrl:r.key_delivery_url}),i&&n.protectionInfo.push({type:"PlayReady",authenticationToken:"Bearer="+i.token,keyDeliveryUrl:i.key_delivery_url})):"fps"===a.encryption_type&&(n.protectionInfo=[{type:"FairPlay",authenticationToken:"Bearer "+a.token,certificateUrl:e.fairplay_certificate_url,keyDeliveryUrl:a.key_delivery_url}])),t.push(n)}),t}setupChromecast(e,t){return new Promise((a,r)=>{const i=document.querySelector(e),n=document.createElement("google-cast-launcher");if(i.appendChild(n),t){window.__onGCastApiAvailable=e=>{e&&cast&&cast.framework&&(this.initializeCastApi(t),setTimeout(()=>{a()},1e3))};const e=document.createElement("script");e.src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",document.head.appendChild(e)}else r("Chromecast Receiver Application Id is missing")})}initializeCastApi(e){cast.framework.CastContext.getInstance().setOptions({receiverApplicationId:e,autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),this.castContext=cast.framework.CastContext.getInstance(),this.castPlayer=new cast.framework.RemotePlayer,this.castPlayerController=new cast.framework.RemotePlayerController(this.castPlayer)}getCastMediaInfo(e){if(e&&e.config&&e.config.player){const t=e.config.options.map((e,t)=>{const a=t+1,r=new chrome.cast.media.Track(a,chrome.cast.media.TrackType.TEXT);return r.trackContentId=e.src,r.trackContentType="text/vtt",r.subtype=chrome.cast.media.TextTrackType.SUBTITLES,r.name=e.label,r.language=e.srclang,r.customDate=null,r}),a="application/vnd.ms-sstr+xml",r=e.config.player.find(e=>e.type===a);let i=null;r&&r.protectionInfo&&(i=r.protectionInfo.find(e=>"PlayReady"===e.type));const n=i?i.authenticationToken:null,s=new chrome.cast.media.MediaInfo(r.src,a);s.streamType=chrome.cast.media.StreamType.BUFFERED,s.metadata=new chrome.cast.media.GenericMediaMetadata,s.metadata.metadataType=chrome.cast.media.MetadataType.GENERIC,s.metadata.title=e.article.name,s.tracks=t;const o=n?{...this.getLicenseUrlFromSrc(i.keyDeliveryUrl,n)}:{};return s.customData={...o,pulseToken:e.pulseToken},s.currentTime=e.currentTime,s.autoplay=!0,s}return null}getLicenseUrlFromSrc(e,t){if(t){return{licenseUrl:(e.includes("?")?`${e}&token=`:`${e}?token=`)+encodeURIComponent(t),token:t}}return{}}castVideo({apiBaseUrl:e,projectId:t,articleId:a,assetId:r,token:i}){if(!e)return Promise.reject("apiBaseUrl property is missing");if(!a)return Promise.reject("articleId property is missing");if(!r)return Promise.reject("assetId property is missing");if(!t)return Promise.reject("projectId property is missing");const n=`${e}/graphql/${t}`;return this.getPlayConfig(n,a,r,null,i).then(e=>{if(this.isConnected()){const t=this.castContext.getCurrentSession(),a=this.getCastMediaInfo(e);if(a){const r=new chrome.cast.media.LoadRequest(a);return r.currentTime=e.currentTime,t.loadMedia(r)}throw{message:"Unexpected manifest format in articlePlayConfig"}}return e})}isConnected(){return this.castPlayer&&this.castPlayer.isConnected}stopCasting(){cast.framework.CastContext.getInstance().getCurrentSession().endSession(!0)}getCastPlayer(){return this.castPlayer}getCastPlayerController(){return this.castPlayerController}}
